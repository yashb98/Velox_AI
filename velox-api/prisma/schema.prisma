// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  // Include both native (dev) and Alpine/arm64 container binary targets
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum ConversationStatus {
  ACTIVE
  COMPLETED
  FAILED
  ABANDONED
}

enum TransactionType {
  CREDIT
  DEBIT
}

// ============================================================================
// CORE MODELS
// ============================================================================

// 1. Organization ( The Tenant )
model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique

  // Billing
  stripe_customer_id     String?
  stripe_subscription_id String?
  current_plan           String? // STARTER, PRO, ENTERPRISE
  credit_balance         Int     @default(0) // Minutes available
  reserved_balance       Int     @default(0) // Minutes reserved for in-progress calls (pre-auth)
  billing_email          String?

  // Security
  api_key_hash String @unique

  // Optimistic locking — prevents concurrent billing race conditions
  version Int @default(0)

  // Soft delete
  deletedAt DateTime?

  // Relations
  users            User[]
  agents           Agent[]
  transactions     Transaction[]
  knowledgeBases   KnowledgeBase[]
  callReservations CallReservation[]
  toolPermissions  ToolPermission[]
  auditLogs        AuditLog[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("organizations")
}

// 2. User ( The Member )
model User {
  id    String @id @default(uuid())
  email String @unique
  role  Role   @default(VIEWER)

  // Soft delete
  deletedAt DateTime?

  org_id String
  org    Organization @relation(fields: [org_id], references: [id])

  auditLogs AuditLog[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("users")
}

// 3. Agent ( The AI Config )
model Agent {
  id            String  @id @default(uuid())
  name          String
  system_prompt String  @db.Text
  voice_id      String
  phone_number  String? // Twilio phone number for this agent

  tools_enabled Json @default("[]")
  llm_config    Json @default("{}")

  // Active flag — disabled agents reject incoming calls without being deleted
  is_active Boolean @default(true)

  // Soft delete
  deletedAt DateTime?

  kb_id String?
  kb    KnowledgeBase? @relation(fields: [kb_id], references: [id])

  org_id String
  org    Organization @relation(fields: [org_id], references: [id])

  conversations Conversation[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([kb_id])
  @@index([phone_number])
  @@index([org_id])
  @@map("agents")
}

// 4. Conversation ( The Call )
model Conversation {
  id         String             @id @default(uuid())
  twilio_sid String             @unique
  status     ConversationStatus @default(ACTIVE)

  start_time DateTime  @default(now())
  end_time   DateTime?

  // Decimal avoids floating-point rounding errors on financial values
  cost_accrued    Decimal @default(0) @db.Decimal(10, 6)
  sentiment_score Float?  // -1.0 (negative) to 1.0 (positive)

  // Soft delete
  deletedAt DateTime?

  agent_id String
  agent    Agent  @relation(fields: [agent_id], references: [id])

  messages Message[]

  @@index([agent_id])
  @@index([start_time])
  @@index([agent_id, start_time]) // compound — dashboard "calls today per agent"
  @@map("conversations")
}

// 5. Message ( The Audit Trail )
model Message {
  id      String @id @default(uuid())
  role    String // user, assistant, system, tool
  content String @db.Text

  tokens     Int @default(0)
  latency_ms Int @default(0)

  conversation_id String
  conversation    Conversation @relation(fields: [conversation_id], references: [id])

  created_at DateTime @default(now())

  @@index([conversation_id])
  @@map("messages")
}

// ============================================================================
// BILLING MODELS
// ============================================================================

// 6. Transaction ( The Billing Ledger )
model Transaction {
  id     String          @id @default(uuid())
  org_id String
  org    Organization    @relation(fields: [org_id], references: [id])

  type          TransactionType
  amount        Int    // Minutes
  description   String
  balance_after Int

  conversation_id String?

  created_at DateTime @default(now())

  @@index([org_id])
  @@index([org_id, created_at]) // compound — billing history queries
  @@map("transactions")
}

// 7. CallReservation ( Billing Pre-Authorization )
// Created when a call starts; deleted when the call ends and final charge is applied.
model CallReservation {
  id               String       @id @default(uuid())
  call_sid         String       @unique
  org_id           String
  org              Organization @relation(fields: [org_id], references: [id])
  reserved_minutes Int

  created_at DateTime @default(now())

  @@index([org_id])
  @@map("call_reservations")
}

// ============================================================================
// ACCESS CONTROL MODELS
// ============================================================================

// 8. ToolPermission ( Per-org tool access control )
model ToolPermission {
  id                 String       @id @default(uuid())
  org_id             String
  org                Organization @relation(fields: [org_id], references: [id])
  tool_name          String
  enabled            Boolean      @default(true)
  rate_limit_per_min Int          @default(10)

  @@unique([org_id, tool_name])
  @@index([org_id])
  @@map("tool_permissions")
}

// 9. AuditLog ( Immutable change history )
model AuditLog {
  id             String       @id @default(uuid())
  org_id         String
  org            Organization @relation(fields: [org_id], references: [id])
  user_id        String?
  user           User?        @relation(fields: [user_id], references: [id])
  action         String       // e.g. "UPDATE_AGENT", "CANCEL_SUBSCRIPTION"
  entity         String       // e.g. "Agent", "Organization"
  previous_value Json?
  new_value      Json?

  created_at DateTime @default(now())

  @@index([org_id, created_at])
  @@map("audit_logs")
}

// ============================================================================
// RAG MODELS
// ============================================================================

// 10. KnowledgeBase ( The RAG Container )
model KnowledgeBase {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text

  embedding_model String @default("text-embedding-004")
  chunk_size      Int    @default(512)
  chunk_overlap   Int    @default(50)

  org_id String
  org    Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  agents Agent[]
  chunks KnowledgeChunk[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([org_id])
  @@map("knowledge_bases")
}

// 11. KnowledgeChunk ( The RAG Document Fragments )
model KnowledgeChunk {
  id      String @id @default(uuid())
  content String @db.Text

  // SHA-256 hash of content for chunk deduplication before insert
  content_hash String?

  // pgvector embedding — HNSW index applied via raw SQL migration
  embedding Unsupported("vector(768)")?

  // PostgreSQL full-text search vector — Gin index below
  content_tsv Unsupported("tsvector")?

  metadata Json @default("{}")

  kb_id String
  kb    KnowledgeBase @relation(fields: [kb_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([kb_id])
  @@index([content_hash])
  @@index([content_tsv], type: Gin)
  @@map("knowledge_chunks")
}
